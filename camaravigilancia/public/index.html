<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GrowXpertIT HD AI SECURITY</title>
    <script src="/socket.io/socket.io.js"></script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

    <style>
        body { margin: 0; background: #000; color: #00ff41; font-family: 'Courier New', monospace; overflow: hidden; }
        
        #login-screen { position: fixed; inset: 0; background: #050505; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid #00ff41; }
        input { background: #111; border: 1px solid #00ff41; color: #00ff41; padding: 12px; margin: 5px; outline: none; text-align: center; }
        
        .monitor { position: relative; width: 100vw; height: 100vh; display: none; }
        
        #canvas-container { position: relative; width: 100%; height: 100vh; display: flex; justify-content: center; align-items: center; background: #000; }
        canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; }
        video { position: absolute; visibility: hidden; } 

        .ui-overlay { position: absolute; width: 100%; height: 100%; pointer-events: none; padding: 20px; box-sizing: border-box; z-index: 10; }
        .top-left { top: 0; left: 0; border-left: 4px solid #00ff41; padding-left: 15px; background: rgba(0,0,0,0.5); }
        .top-right { top: 0; right: 0; text-align: right; background: rgba(0,0,0,0.5); padding-right: 15px;}
        
        .btn-panel { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 15px; pointer-events: all; z-index: 100; }
        button { background: rgba(0, 255, 65, 0.8); color: #000; border: 1px solid #00ff41; padding: 15px 30px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        button.alarm { background: rgba(255, 0, 0, 0.8); color: #fff; border: 1px solid #ff0000; }

        #status-bar { position: absolute; bottom: 90px; width: 100%; text-align: center; background: rgba(0,0,0,0.7); padding: 5px; z-index: 90; font-weight: bold; }
        
        #intruder-ui { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); padding: 30px; border: 3px solid #ff0000; z-index: 200; text-align: center; pointer-events: all; box-shadow: 0 0 30px #ff0000; }
        .blink-red { animation: blink 1s infinite; color: red; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="letter-spacing: 5px;">GROWXPERT-IT</h1>
        <h3>HD BIOMETRIC SYSTEM</h3>
        <input type="password" id="pass" placeholder="C√ìDIGO DE ACCESO">
        <button onclick="checkLogin()" style="margin-top: 20px;">INICIAR TERMINAL</button>
    </div>

    <div class="monitor" id="main-ui">
        
        <div id="intruder-ui">
            <div style="color: #ff0000; font-size: 2em; font-weight: bold; margin-bottom: 20px;">‚ö†Ô∏è ALERTA DE INTRUSO</div>
            <div style="font-size: 4em; font-weight: bold; color: white;"><span id="timer-val">30</span>s</div>
            <input type="text" id="subject-name" placeholder="Nombre para BD..." style="font-size: 1.2em; margin-top: 15px;">
            <br><br>
            <button onclick="saveSubject()" style="font-size: 1.2em;">AUTORIZAR Y GUARDAR</button>
        </div>

        <div class="ui-overlay top-left">
            <div style="font-size: 1.5em;"><strong>GROWXPERT-IT HD_NODE</strong></div>
            <div id="date">--/--/----</div>
            <div id="db-count" style="color: cyan; font-weight: bold;">[BD BIOM√âTRICA: 0 SUJETOS]</div>
            <div id="user-count">VISORES: 0</div>
        </div>
        <div class="ui-overlay top-right">
            <div class="blink-red" style="font-size: 1.2em;">‚óè LIVE 720p</div>
            <div id="clock" style="font-size: 1.5em;">00:00:00</div>
        </div>

        <div id="canvas-container">
            <canvas id="video-canvas"></canvas>
            <canvas id="ai-canvas"></canvas>
        </div>

        <div id="status-bar">SISTEMA INICIALIZANDO MOTORES IA...</div>

        <div class="btn-panel">
            <button id="btnTransmit" style="display:none;" onclick="startEverything()">‚ñ∂ ARMAR SENSORES DUALES (PC)</button>
            <button class="alarm" onclick="sendAlarm()">üö® ALARMA GLOBAL</button>
        </div>
    </div>

    <video id="video" autoplay playsinline mute></video>
    
    <script>
        const socket = io();
        const video = document.getElementById('video');
        const vCanvas = document.getElementById('video-canvas');
        const aCanvas = document.getElementById('ai-canvas');
        const vCtx = vCanvas.getContext('2d');
        const aCtx = aCanvas.getContext('2d');
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        let modelsLoaded = false;
        let cocoModel = null; 
        let knownFacesDB = []; 
        let faceMatcher = null; 
        let latestUnknownDescriptor = null; 
        let currentFaces = [];
        let currentBodies = [];
        let timerIntruso = null;
        let segundosRestantes = 30;

        function checkLogin() {
            if(document.getElementById('pass').value === 'GrowXpert1234') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-ui').style.display = 'block';
                loadModels();
            } else { alert('ACCESO DENEGADO'); }
        }

        async function loadModels() {
            document.getElementById('status-bar').innerText = "CARGANDO REDES NEURONALES (Alta Precisi√≥n)...";
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
            cocoModel = await cocoSsd.load();
            
            modelsLoaded = true;
            document.getElementById('status-bar').innerText = "SISTEMA LISTO. IA EN ESPERA.";
            if(!isMobile) document.getElementById('btnTransmit').style.display = 'block';
            updateClock();
        }

        async function startEverything() {
            // HACK HARDWARE: Solicitamos HD pero a un m√°ximo de 15 FPS para ganar LUZ.
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 1280 }, 
                    height: { ideal: 720 },
                    frameRate: { ideal: 15, max: 20 }
                } 
            });
            video.srcObject = stream;
            document.getElementById('btnTransmit').style.display = 'none';
            document.getElementById('status-bar').innerText = "VIGILANCIA HD ACTIVA CON MEJORA DE BRILLO";
            
            video.addEventListener('loadedmetadata', () => {
                vCanvas.width = aCanvas.width = 1280;
                vCanvas.height = aCanvas.height = 720;
                
                // BUCLE V√çDEO
                setInterval(() => {
                    // HACK SOFTWARE: Aumentamos brillo (+30%) y contraste (+15%)
                    vCtx.filter = 'brightness(1.3) contrast(1.15)';
                    vCtx.drawImage(video, 0, 0, 1280, 720);
                    vCtx.filter = 'none'; // Reseteamos el filtro para no afectar a futuros dibujos
                    
                    drawAI(currentFaces, currentBodies); 

                    socket.emit('streaming', {
                        image: vCanvas.toDataURL('image/jpeg', 0.7),
                        faces: currentFaces,
                        bodies: currentBodies
                    });
                }, 100);

                // BUCLE IA
                if(modelsLoaded) {
                    setInterval(async () => {
                        const predictions = await cocoModel.detect(video);
                        currentBodies = predictions
                            .filter(p => p.class === 'person' && p.score > 0.5) 
                            .map(p => ({ x: p.bbox[0], y: p.bbox[1], w: p.bbox[2], h: p.bbox[3] }));

                        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 416 }))
                            .withFaceLandmarks().withFaceDescriptors();
                        
                        const resizedDetections = faceapi.resizeResults(detections, { width: 1280, height: 720 });
                        
                        currentFaces = resizedDetections.map(d => {
                            const box = d.detection.box;
                            let label = "DESCONOCIDO";
                            
                            if (faceMatcher) {
                                const match = faceMatcher.findBestMatch(d.descriptor);
                                if (match.label !== "unknown") { label = match.label; } 
                                else { latestUnknownDescriptor = d.descriptor; }
                            } else { latestUnknownDescriptor = d.descriptor; }

                            return { x: box.x, y: box.y, w: box.width, h: box.height, name: label };
                        });
                    }, 400); 
                }
            });
        }

        function drawAI(faces, bodies) {
            aCtx.clearRect(0, 0, aCanvas.width, aCanvas.height);
            
            bodies.forEach(body => {
                aCtx.strokeStyle = "rgba(0, 170, 255, 0.6)"; aCtx.lineWidth = 4;
                aCtx.strokeRect(body.x, body.y, body.w, body.h);
                aCtx.fillStyle = "#00aaff"; aCtx.font = "bold 18px monospace";
                aCtx.fillText("HUMANO DETECTADO", body.x, body.y - 10);
            });

            faces.forEach(face => {
                const colorHex = face.name !== "DESCONOCIDO" ? "#00ff41" : "#ff0000";
                aCtx.strokeStyle = colorHex; aCtx.lineWidth = 4;
                aCtx.strokeRect(face.x, face.y, face.w, face.h);
                aCtx.fillStyle = colorHex; aCtx.font = "bold 22px monospace";
                aCtx.fillText("ID: " + face.name, face.x, face.y - 15);
            });
        }

        // --- L√ìGICA DEL RECEPTOR (M√ìVIL) ---
        socket.on('play-stream', (data) => {
            const img = new Image();
            img.onload = () => {
                vCanvas.width = aCanvas.width = 1280; 
                vCanvas.height = aCanvas.height = 720;
                
                // Aplicamos tambi√©n un ligero brillo al m√≥vil por si acaso la pantalla del m√≥vil es oscura
                vCtx.filter = 'brightness(1.1)';
                vCtx.drawImage(img, 0, 0);
                vCtx.filter = 'none';

                aCtx.clearRect(0, 0, aCanvas.width, aCanvas.height);
                
                let hayDesconocidos = false;

                if(data.bodies) {
                    data.bodies.forEach(body => {
                        aCtx.strokeStyle = "rgba(0, 170, 255, 0.6)"; aCtx.lineWidth = 4;
                        aCtx.strokeRect(body.x, body.y, body.w, body.h);
                        aCtx.fillStyle = "#00aaff"; aCtx.font = "bold 18px monospace";
                        aCtx.fillText("HUMANO DETECTADO", body.x, body.y - 10);
                    });
                }

                if(data.faces) {
                    data.faces.forEach(face => {
                        const isKnown = face.name !== "DESCONOCIDO";
                        if(!isKnown) hayDesconocidos = true;

                        aCtx.strokeStyle = isKnown ? "#00ff41" : "#ff0000"; aCtx.lineWidth = 4;
                        aCtx.strokeRect(face.x, face.y, face.w, face.h);
                        aCtx.fillStyle = isKnown ? "#00ff41" : "#ff0000"; aCtx.font = "bold 22px monospace";
                        aCtx.fillText("ID: " + face.name, face.x, face.y - 15);
                    });
                }

                if (hayDesconocidos && isMobile) {
                    if (!timerIntruso) startIntruderTimer();
                } else if (!hayDesconocidos) { resetIntruderTimer(); }
            };
            img.src = data.image; 
        });

        socket.on('register-subject', (name) => {
            if (latestUnknownDescriptor && !isMobile) {
                const newProfile = new faceapi.LabeledFaceDescriptors(name.toUpperCase(), [latestUnknownDescriptor]);
                knownFacesDB.push(newProfile);
                faceMatcher = new faceapi.FaceMatcher(knownFacesDB, 0.5); 
                document.getElementById('db-count').innerText = "[BD BIOM√âTRICA: " + knownFacesDB.length + " SUJETOS]";
                latestUnknownDescriptor = null;
            }
        });

        function startIntruderTimer() {
            document.getElementById('intruder-ui').style.display = 'block';
            segundosRestantes = 30;
            document.getElementById('timer-val').innerText = segundosRestantes;
            timerIntruso = setInterval(() => {
                segundosRestantes--;
                document.getElementById('timer-val').innerText = segundosRestantes;
                if (segundosRestantes <= 0) { clearInterval(timerIntruso); sendAlarm(); }
            }, 1000);
        }

        function resetIntruderTimer() {
            clearInterval(timerIntruso);
            timerIntruso = null;
            document.getElementById('intruder-ui').style.display = 'none';
        }

        function saveSubject() {
            const name = document.getElementById('subject-name').value;
            if (name) {
                socket.emit('learn-subject', name); 
                document.getElementById('subject-name').value = "";
                resetIntruderTimer();
            }
        }

        function sendAlarm() { socket.emit('trigger-alarm'); }

        socket.on('action-alarm', () => {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sawtooth'; oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start();
            document.body.style.background = "red";
            setTimeout(() => { osc.stop(); document.body.style.background = "black"; }, 3000);
        });

        socket.on('user-count', c => document.getElementById('user-count').innerText = "VISORES: " + c);

        function updateClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock').innerText = now.toLocaleTimeString();
                document.getElementById('date').innerText = now.toLocaleDateString();
            }, 1000);
        }
    </script>
</body>
</html>

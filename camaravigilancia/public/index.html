<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrowXpertIT AI Security Pro</title>
    <script src="/socket.io/socket.io.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        body { margin: 0; background: #000; color: #00ff41; font-family: 'Courier New', monospace; overflow: hidden; }
        #login-screen { position: fixed; inset: 0; background: #050505; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        input { background: #111; border: 1px solid #00ff41; color: #00ff41; padding: 10px; margin: 5px; outline: none; }
        .monitor { position: relative; width: 100vw; height: 100vh; display: none; }
        #canvas-container { position: relative; width: 100%; height: 85%; display: flex; justify-content: center; align-items: center; background: #000; }
        canvas { position: absolute; }
        video { position: absolute; visibility: hidden; } /* Procesado en background */
        .ui-overlay { position: absolute; width: 100%; height: 100%; pointer-events: none; padding: 20px; z-index: 10; }
        .top-left { top: 0; left: 0; }
        .top-right { top: 0; right: 0; text-align: right; padding-right: 40px; }
        .btn-panel { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; gap: 10px; pointer-events: all; z-index: 20; }
        button { background: #00ff41; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; }
        button.alarm { background: #ff0000; color: #fff; }
        #status-bar { position: absolute; bottom: 80px; width: 100%; text-align: center; background: rgba(0,255,0,0.1); }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>GROWXPERT-IT SECURE ACCESS</h2>
        <input type="text" id="user" placeholder="USUARIO">
        <input type="password" id="pass" placeholder="CONTRASEÑA">
        <button onclick="checkLogin()">ACCEDER AL SISTEMA</button>
    </div>

    <div class="monitor" id="main-ui">
        <div class="ui-overlay top-left">
            <div><strong>GROWXPERT-IT AI SYSTEM</strong></div>
            <div id="date">--/--/----</div>
            <div>USERS: <span id="user-count">0</span></div>
        </div>
        <div class="ui-overlay top-right">
            <div style="color: red; animation: blink 1s infinite;">● LIVE</div>
            <div id="clock">00:00:00</div>
        </div>

        <div id="canvas-container">
            <canvas id="video-canvas"></canvas>
            <canvas id="ai-canvas"></canvas>
        </div>

        <div id="status-bar">SISTEMA INICIALIZANDO...</div>

        <div class="btn-panel">
            <button id="btnTransmit" style="display:none;" onclick="startEverything()">1. ACTIVAR CÁMARA E IA</button>
            <button class="alarm" onclick="sendAlarm()">⚠️ ACTIVAR ALARMA REMOTA</button>
        </div>
    </div>

    <video id="video" autoplay playsinline mute></video>
    <script>
        const socket = io();
        const video = document.getElementById('video');
        const vCanvas = document.getElementById('video-canvas');
        const aCanvas = document.getElementById('ai-canvas');
        const vCtx = vCanvas.getContext('2d');
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        let modelsLoaded = false;

        function checkLogin() {
            if(document.getElementById('user').value === 'admin' && document.getElementById('pass').value === 'GrowXpert1234') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-ui').style.display = 'block';
                loadModels();
            } else { alert('Acceso Denegado'); }
        }

        async function loadModels() {
            document.getElementById('status-bar').innerText = "CARGANDO MODELOS DE IA...";
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            modelsLoaded = true;
            document.getElementById('status-bar').innerText = "SISTEMA LISTO";
            if(!isMobile) document.getElementById('btnTransmit').style.display = 'block';
            updateClock();
        }

        async function startEverything() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            document.getElementById('btnTransmit').innerText = "SISTEMA ARMADO Y TRANSMITIENDO";
            
            setInterval(async () => {
                // Ajustar tamaños
                vCanvas.width = aCanvas.width = 640;
                vCanvas.height = aCanvas.height = 480;
                
                // Dibujar video
                vCtx.drawImage(video, 0, 0, 640, 480);
                
                // Detección IA
                if(modelsLoaded) {
                    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
                    const resizedDetections = faceapi.resizeResults(detections, { width: 640, height: 480 });
                    
                    // Dibujar cuadrados
                    faceapi.draw.drawDetections(aCanvas, resizedDetections);
                }

                // Enviar al servidor
                socket.emit('streaming', vCanvas.toDataURL('image/jpeg', 0.5));
            }, 100);
        }

        // --- SISTEMA DE ALARMA MEJORADO ---
        function sendAlarm() {
            socket.emit('trigger-alarm');
        }

        socket.on('action-alarm', () => {
            // Generar sonido sintético (no depende de archivos externos)
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // Tono de alarma
            oscillator.connect(gain);
            gain.connect(audioCtx.destination);
            
            oscillator.start();
            document.body.style.background = "red";
            
            setTimeout(() => {
                oscillator.stop();
                document.body.style.background = "black";
            }, 3000);
        });

        // --- RECIBIR STREAM (MÓVIL) ---
        socket.on('play-stream', (imgData) => {
            const img = new Image();
            img.onload = () => {
                vCanvas.width = 640; vCanvas.height = 480;
                vCtx.drawImage(img, 0, 0);
            };
            img.src = imgData;
        });

        socket.on('user-count', c => document.getElementById('user-count').innerText = c);

        function updateClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock').innerText = now.toLocaleTimeString();
                document.getElementById('date').innerText = now.toLocaleDateString();
            }, 1000);
        }
    </script>
</body>
</html>

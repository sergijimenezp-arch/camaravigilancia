<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrowXpertIT - AI Security Suite PRO</title>
    <script src="/socket.io/socket.io.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        body { margin: 0; background: #000; color: #00ff41; font-family: 'Courier New', monospace; overflow: hidden; }
        
        /* LOGIN */
        #login-screen { 
            position: fixed; inset: 0; background: #050505; z-index: 1000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-box { border: 1px solid #00ff41; padding: 40px; background: #000; text-align: center; }
        input { background: #000; border: 1px solid #00ff41; color: #00ff41; padding: 12px; margin: 10px; font-family: monospace; outline: none; }
        
        /* MONITOR */
        .monitor { position: relative; width: 100vw; height: 100vh; display: none; border: 15px solid #1a1a1a; box-sizing: border-box; }
        #canvas-container { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: #000;}
        
        /* El Canvas es donde se ve la c√°mara */
        canvas { 
            width: 100%; height: 100%; 
            object-fit: contain; /* Esto asegura que el video se vea bien en cualquier pantalla */
            max-width: 1000px;
        }

        /* HUD */
        .hud { position: absolute; inset: 0; pointer-events: none; z-index: 10; padding: 25px; box-sizing: border-box; }
        .top-left { position: absolute; top: 25px; left: 25px; border-left: 3px solid #00ff41; padding-left: 10px; }
        .top-right { position: absolute; top: 25px; right: 40px; text-align: right; }
        .bottom-center { position: absolute; bottom: 120px; width: 100%; text-align: center; left: 0; }

        /* ALERTA */
        #intruder-box { display: none; background: rgba(255, 0, 0, 0.4); border: 2px solid #ff0000; padding: 15px; color: #fff; animation: pulse 0.8s infinite; }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* CONTROLES */
        .ui-panel { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 15px; pointer-events: all; z-index: 100; }
        .btn { background: #00ff41; color: #000; border: none; padding: 12px 24px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-danger { background: #ff0000; color: #fff; }

        #debug-msg { position: absolute; bottom: 5px; right: 5px; font-size: 8px; color: #333; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>GROWXPERT-IT SECURITY</h2>
            <input type="text" id="user-input" placeholder="USERNAME"><br>
            <input type="password" id="pass-input" placeholder="ACCESS CODE"><br>
            <button class="btn" onclick="validateLogin()">INITIALIZE SYSTEM</button>
        </div>
    </div>

    <div class="monitor" id="main-ui">
        <div class="hud">
            <div class="top-left">
                <strong>GROWXPERT-IT NODE_01</strong><br>
                <span id="date-display"></span><br>
                <span id="status-text" style="color:yellow">STATUS: STANDBY</span>
            </div>
            <div class="top-right">
                <span style="color:red">‚óè LIVE</span><br>
                <span id="clock-display" style="font-size: 1.5em;"></span>
            </div>
            <div class="bottom-center">
                <div id="intruder-box">
                    ‚ö†Ô∏è INTRUSO DESCONOCIDO<br>
                    <span id="timer-display" style="font-size: 3em;">30</span>s
                </div>
            </div>
        </div>

        <div id="canvas-container">
            <canvas id="main-canvas"></canvas>
        </div>

        <div class="ui-panel">
            <button id="btn-pc-start" class="btn" style="display:none" onclick="initCameraPC()">ARMAR SISTEMA (PC)</button>
            <div id="mobile-tools" style="display:none">
                <input type="text" id="id-name" placeholder="NOMBRE...">
                <button class="btn" onclick="authorizeSubject()">IDENTIFICAR</button>
                <button class="btn btn-danger" onclick="socket.emit('trigger-alarm')">üö® ALARMA</button>
            </div>
        </div>
        <div id="debug-msg">GrowXpertIT_v4.2_Live_Active</div>
    </div>

    <video id="v-source" autoplay playsinline muted style="display:none"></video>

    <script>
        const socket = io();
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('v-source');
        
        let intruderActive = false;
        let countdown = null;
        let isAuthorized = false;
        let currentFaces = [];

        function validateLogin() {
            if(document.getElementById('user-input').value === 'admin' && document.getElementById('pass-input').value === 'GrowXpert1234') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-ui').style.display = 'block';
                isMobile ? document.getElementById('mobile-tools').style.display = 'block' : document.getElementById('btn-pc-start').style.display = 'block';
                setupIA();
                setInterval(updateTime, 1000);
            } else { alert("Error de acceso"); }
        }

        async function setupIA() {
            await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
            document.getElementById('status-text').innerText = "STATUS: READY";
        }

        // --- EMISOR (EL PC QUE TIENE LA C√ÅMARA) ---
        async function initCameraPC() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            document.getElementById('btn-pc-start').style.display = 'none';
            document.getElementById('status-text').innerText = "STATUS: TRANSMITTING";

            // Bucle de transmisi√≥n
            setInterval(async () => {
                canvas.width = 640; canvas.height = 480;
                ctx.drawImage(video, 0, 0, 640, 480); // Dibuja para el PC mismo
                
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
                currentFaces = detections.map(d => ({ x: d.box.x, y: d.box.y, w: d.box.width, h: d.box.height }));

                // Dibujar cuadros localmente
                drawUI(currentFaces);

                socket.emit('streaming', {
                    image: canvas.toDataURL('image/jpeg', 0.3),
                    faces: currentFaces
                });
            }, 100);
        }

        // --- RECEPTOR (EL M√ìVIL QUE VE) ---
        socket.on('play-stream', (data) => {
            const img = new Image();
            img.onload = () => {
                canvas.width = 640; canvas.height = 480;
                ctx.drawImage(img, 0, 0); // Dibuja la imagen recibida
                drawUI(data.faces); // Dibuja los cuadros de IA recibidos
                
                if(data.faces.length > 0 && !isAuthorized && !intruderActive) startTimer();
                else if(data.faces.length === 0) stopTimer();
            };
            img.src = data.image;
        });

        function drawUI(faces) {
            faces.forEach(f => {
                ctx.strokeStyle = isAuthorized ? "#00ff41" : "#ff0000";
                ctx.lineWidth = 4;
                ctx.strokeRect(f.x, f.y, f.w, f.h);
                ctx.fillStyle = isAuthorized ? "#00ff41" : "#ff0000";
                ctx.fillText(isAuthorized ? "IDENTIFICADO" : "DESCONOCIDO", f.x, f.y - 10);
            });
        }

        // --- L√ìGICA DE ALARMA ---
        function startTimer() {
            intruderActive = true;
            let s = 30;
            document.getElementById('intruder-box').style.display = 'block';
            countdown = setInterval(() => {
                s--;
                document.getElementById('timer-display').innerText = s;
                if(s <= 0) { socket.emit('trigger-alarm'); stopTimer(); }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(countdown);
            intruderActive = false;
            document.getElementById('intruder-box').style.display = 'none';
        }

        function authorizeSubject() {
            isAuthorized = true;
            stopTimer();
            setTimeout(() => { isAuthorized = false; }, 10000);
        }

        socket.on('action-alarm', () => {
            const audioCtx = new AudioContext();
            const osc = audioCtx.createOscillator();
            osc.type = 'sawtooth';
            osc.frequency.value = 880;
            osc.connect(audioCtx.destination);
            osc.start();
            document.body.style.background = "red";
            setTimeout(() => { osc.stop(); document.body.style.background = "#000"; }, 5000);
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('clock-display').innerText = now.toLocaleTimeString();
            document.getElementById('date-display').innerText = now.toLocaleDateString();
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GrowXpertIT - AI Intruder Detection</title>
    <script src="/socket.io/socket.io.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        body { margin: 0; background: #000; color: #00ff41; font-family: monospace; overflow: hidden; }
        .monitor { position: relative; width: 100vw; height: 100vh; display: none; }
        #canvas-container { position: relative; width: 100%; height: 70%; display: flex; justify-content: center; background: #000; }
        canvas { position: absolute; width: 100%; max-width: 640px; }
        
        /* Panel de Control M贸vil */
        #mobile-controls { position: absolute; bottom: 0; width: 100%; height: 30%; background: #111; border-top: 2px solid #00ff41; padding: 15px; box-sizing: border-box; display: none; }
        input { background: #000; border: 1px solid #00ff41; color: #00ff41; padding: 10px; width: 60%; }
        
        .timer-box { color: #ff0000; font-size: 1.5em; font-weight: bold; }
        .alert-bg { animation: danger 0.5s infinite; }
        @keyframes danger { 0% { background: #000; } 50% { background: #300; } }
    </style>
</head>
<body>

    <div id="login-screen" style="text-align:center; padding-top:100px;">
        <h2>GROWXPERT-IT SECURITY</h2>
        <input type="password" id="pass" placeholder="PASSWORD">
        <button onclick="login()">ENTRAR</button>
    </div>

    <div class="monitor" id="main-ui">
        <div id="canvas-container">
            <canvas id="video-canvas"></canvas>
            <canvas id="ai-canvas"></canvas>
        </div>

        <div id="status-info" style="padding: 10px; text-align: center;">ESPERANDO SEAL...</div>

        <div id="mobile-controls">
            <div id="intruder-alert" style="display:none;">
                <div class="timer-box">锔 INTRUSO DETECTADO: <span id="timer">30</span>s</div>
                <input type="text" id="face-name" placeholder="Nombre del sujeto...">
                <button onclick="identifyFace()" style="background:#00ff41; color:#000; padding:10px;">IDENTIFICAR</button>
            </div>
            <button onclick="socket.emit('trigger-alarm')" style="background:red; color:white; width:100%; margin-top:10px; padding:15px;"> ALARMA MANUAL</button>
        </div>

        <button id="btnPC" style="display:none; position:absolute; bottom:20px; left:50%; transform:translateX(-50%); padding:20px;" onclick="startPC()">INICIAR CMARA LOCAL</button>
    </div>

    <video id="video" autoplay playsinline muted style="display:none;"></video>

    <script>
        const socket = io();
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        let intruderTimer = null;
        let timeLeft = 30;
        let currentSubjectRecognized = false;

        function login() {
            if(document.getElementById('pass').value === 'GrowXpert1234') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-ui').style.display = 'block';
                if(isMobile) document.getElementById('mobile-controls').style.display = 'block';
                else document.getElementById('btnPC').style.display = 'block';
                loadIA();
            }
        }

        async function loadIA() {
            const URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            await faceapi.nets.tinyFaceDetector.loadFromUri(URL);
            document.getElementById('status-info').innerText = "IA LISTA";
        }

        // L贸gica del PC (Emisor)
        async function startPC() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            document.getElementById('video').srcObject = stream;
            
            const vCanvas = document.getElementById('video-canvas');
            const ctx = vCanvas.getContext('2d');

            setInterval(async () => {
                vCanvas.width = 640; vCanvas.height = 480;
                ctx.drawImage(document.getElementById('video'), 0, 0, 640, 480);
                
                const detections = await faceapi.detectAllFaces(document.getElementById('video'), new faceapi.TinyFaceDetectorOptions());
                
                socket.emit('streaming', {
                    image: vCanvas.toDataURL('image/jpeg', 0.4),
                    hasFace: detections.length > 0,
                    faces: detections.map(d => ({ x: d.box.x, y: d.box.y, w: d.box.width, h: d.box.height }))
                });
            }, 200);
        }

        // L贸gica del M贸vil (Receptor)
        socket.on('play-stream', (data) => {
            const vCanvas = document.getElementById('video-canvas');
            const ctx = vCanvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                vCanvas.width = 640; vCanvas.height = 480;
                ctx.drawImage(img, 0, 0);
                
                // Dibujar cuadros
                data.faces.forEach(f => {
                    ctx.strokeStyle = currentSubjectRecognized ? "#00ff41" : "#ff0000";
                    ctx.lineWidth = 4;
                    ctx.strokeRect(f.x, f.y, f.w, f.h);
                });
            };
            img.src = data.image;

            // Manejo del Temporizador de Intrusos
            if (data.hasFace && !currentSubjectRecognized && !intruderTimer) {
                startIntruderCountdown();
            } else if (!data.hasFace) {
                resetIntruderSystem();
            }
        });

        function startIntruderCountdown() {
            document.getElementById('intruder-alert').style.display = 'block';
            document.body.classList.add('alert-bg');
            timeLeft = 30;
            intruderTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                if (timeLeft <= 0) {
                    socket.emit('trigger-alarm');
                    clearInterval(intruderTimer);
                }
            }, 1000);
        }

        function identifyFace() {
            const name = document.getElementById('face-name').value;
            if(name) {
                currentSubjectRecognized = true;
                socket.emit('learn-face', name);
                resetIntruderSystem();
                document.getElementById('status-info').innerText = "SUJETO AUTORIZADO: " + name;
            }
        }

        function resetIntruderSystem() {
            clearInterval(intruderTimer);
            intruderTimer = null;
            document.getElementById('intruder-alert').style.display = 'none';
            document.body.classList.remove('alert-bg');
        }

        // Alarma Sonora (Sintetizada)
        socket.on('action-alarm', () => {
            const audioCtx = new AudioContext();
            const osc = audioCtx.createOscillator();
            osc.type = 'sawtooth';
            osc.frequency.value = 440;
            osc.connect(audioCtx.destination);
            osc.start();
            setTimeout(() => osc.stop(), 5000);
        });
    </script>
</body>
</html>
